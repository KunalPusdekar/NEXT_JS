{"version":3,"sources":["../../../src/server/after/after.ts"],"sourcesContent":["import { workAsyncStorage } from '../app-render/work-async-storage.external'\nimport { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.external'\nimport { StaticGenBailoutError } from '../../client/components/static-generation-bailout'\n\nimport { markCurrentScopeAsDynamic } from '../app-render/dynamic-rendering'\n\nexport type AfterTask<T = unknown> = Promise<T> | AfterCallback<T>\nexport type AfterCallback<T = unknown> = () => T | Promise<T>\n\n/**\n * This function allows you to schedule callbacks to be executed after the current request finishes.\n */\nexport function unstable_after<T>(task: AfterTask<T>): void {\n  const workStore = workAsyncStorage.getStore()\n  const workUnitStore = workUnitAsyncStorage.getStore()\n\n  if (!workStore) {\n    // TODO(after): the linked docs page talks about *dynamic* APIs, which unstable_after soon won't be anymore\n    throw new Error(\n      '`unstable_after` was called outside a request scope. Read more: https://nextjs.org/docs/messages/next-dynamic-api-wrong-context'\n    )\n  }\n\n  const { afterContext } = workStore\n  if (!afterContext) {\n    throw new Error(\n      '`unstable_after` must be explicitly enabled by setting `experimental.after: true` in your next.config.js.'\n    )\n  }\n\n  // TODO: After should not cause dynamic.\n  const callingExpression = 'unstable_after'\n  if (workStore.forceStatic) {\n    throw new StaticGenBailoutError(\n      `Route ${workStore.route} with \\`dynamic = \"force-static\"\\` couldn't be rendered statically because it used \\`${callingExpression}\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`\n    )\n  } else {\n    markCurrentScopeAsDynamic(workStore, workUnitStore, callingExpression)\n  }\n\n  afterContext.after(task)\n}\n"],"names":["unstable_after","task","workStore","workAsyncStorage","getStore","workUnitStore","workUnitAsyncStorage","Error","afterContext","callingExpression","forceStatic","StaticGenBailoutError","route","markCurrentScopeAsDynamic","after"],"mappings":";;;;+BAYgBA;;;eAAAA;;;0CAZiB;8CACI;yCACC;kCAEI;AAQnC,SAASA,eAAkBC,IAAkB;IAClD,MAAMC,YAAYC,0CAAgB,CAACC,QAAQ;IAC3C,MAAMC,gBAAgBC,kDAAoB,CAACF,QAAQ;IAEnD,IAAI,CAACF,WAAW;QACd,2GAA2G;QAC3G,MAAM,IAAIK,MACR;IAEJ;IAEA,MAAM,EAAEC,YAAY,EAAE,GAAGN;IACzB,IAAI,CAACM,cAAc;QACjB,MAAM,IAAID,MACR;IAEJ;IAEA,wCAAwC;IACxC,MAAME,oBAAoB;IAC1B,IAAIP,UAAUQ,WAAW,EAAE;QACzB,MAAM,IAAIC,8CAAqB,CAC7B,CAAC,MAAM,EAAET,UAAUU,KAAK,CAAC,qFAAqF,EAAEH,kBAAkB,4HAA4H,CAAC;IAEnQ,OAAO;QACLI,IAAAA,2CAAyB,EAACX,WAAWG,eAAeI;IACtD;IAEAD,aAAaM,KAAK,CAACb;AACrB"}