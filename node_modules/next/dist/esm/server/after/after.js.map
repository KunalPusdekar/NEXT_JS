{"version":3,"sources":["../../../src/server/after/after.ts"],"sourcesContent":["import { workAsyncStorage } from '../app-render/work-async-storage.external'\nimport { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.external'\nimport { StaticGenBailoutError } from '../../client/components/static-generation-bailout'\n\nimport { markCurrentScopeAsDynamic } from '../app-render/dynamic-rendering'\n\nexport type AfterTask<T = unknown> = Promise<T> | AfterCallback<T>\nexport type AfterCallback<T = unknown> = () => T | Promise<T>\n\n/**\n * This function allows you to schedule callbacks to be executed after the current request finishes.\n */\nexport function unstable_after<T>(task: AfterTask<T>): void {\n  const workStore = workAsyncStorage.getStore()\n  const workUnitStore = workUnitAsyncStorage.getStore()\n\n  if (!workStore) {\n    // TODO(after): the linked docs page talks about *dynamic* APIs, which unstable_after soon won't be anymore\n    throw new Error(\n      '`unstable_after` was called outside a request scope. Read more: https://nextjs.org/docs/messages/next-dynamic-api-wrong-context'\n    )\n  }\n\n  const { afterContext } = workStore\n  if (!afterContext) {\n    throw new Error(\n      '`unstable_after` must be explicitly enabled by setting `experimental.after: true` in your next.config.js.'\n    )\n  }\n\n  // TODO: After should not cause dynamic.\n  const callingExpression = 'unstable_after'\n  if (workStore.forceStatic) {\n    throw new StaticGenBailoutError(\n      `Route ${workStore.route} with \\`dynamic = \"force-static\"\\` couldn't be rendered statically because it used \\`${callingExpression}\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`\n    )\n  } else {\n    markCurrentScopeAsDynamic(workStore, workUnitStore, callingExpression)\n  }\n\n  afterContext.after(task)\n}\n"],"names":["workAsyncStorage","workUnitAsyncStorage","StaticGenBailoutError","markCurrentScopeAsDynamic","unstable_after","task","workStore","getStore","workUnitStore","Error","afterContext","callingExpression","forceStatic","route","after"],"mappings":"AAAA,SAASA,gBAAgB,QAAQ,4CAA2C;AAC5E,SAASC,oBAAoB,QAAQ,iDAAgD;AACrF,SAASC,qBAAqB,QAAQ,oDAAmD;AAEzF,SAASC,yBAAyB,QAAQ,kCAAiC;AAK3E;;CAEC,GACD,OAAO,SAASC,eAAkBC,IAAkB;IAClD,MAAMC,YAAYN,iBAAiBO,QAAQ;IAC3C,MAAMC,gBAAgBP,qBAAqBM,QAAQ;IAEnD,IAAI,CAACD,WAAW;QACd,2GAA2G;QAC3G,MAAM,IAAIG,MACR;IAEJ;IAEA,MAAM,EAAEC,YAAY,EAAE,GAAGJ;IACzB,IAAI,CAACI,cAAc;QACjB,MAAM,IAAID,MACR;IAEJ;IAEA,wCAAwC;IACxC,MAAME,oBAAoB;IAC1B,IAAIL,UAAUM,WAAW,EAAE;QACzB,MAAM,IAAIV,sBACR,CAAC,MAAM,EAAEI,UAAUO,KAAK,CAAC,qFAAqF,EAAEF,kBAAkB,4HAA4H,CAAC;IAEnQ,OAAO;QACLR,0BAA0BG,WAAWE,eAAeG;IACtD;IAEAD,aAAaI,KAAK,CAACT;AACrB"}